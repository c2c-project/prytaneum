name: Development Workflow

on:
    pull_request_target:
        branches: [dev]
        types: [opened, edited, synchronize]

env:
    GKE_CLUSTER: prytaneum-dev-cluster
    GKE_ZONE: us-central1-a
    CLIENT_DEPLOYMENT: prytaneum-client
    SERVER_DEPLOYMENT: prytaneum-server
    CLIENT_IMAGE: prytaneum-client
    SERVER_IMAGE: prytaneum-server
    NAMESPACE: development
    GRAPHQL_URL: https://dev.prytaneum.io/graphql
    GOOGLE_ANALYTICS_ID: ${{ secrets.GOOGLE_ANALYTICS_ID }}
    # CI is used for playwright e2e testing configuration https://playwright.dev/docs/test-configuration#testing-options
    CI: 1

jobs:
    linting:
        name: Linting
        runs-on: ubuntu-latest
        environment: development

        steps:
            - name: Setup
              uses: actions/checkout@v2

            - uses: actions/setup-node@v2
              with:
                  node-version: '16'

            - name: Yarn Install
              run: yarn install

            - name: Lint Project
              run: yarn workspaces foreach -p run lint

    typechecking:
        name: Type Check
        runs-on: ubuntu-latest
        environment: development

        steps:
            - name: Setup
              uses: actions/checkout@v2

            - uses: actions/setup-node@v2
              with:
                  node-version: '16'

            - name: Yarn Install
              run: yarn install

            - name: Prisma Generate
              run: yarn workspace @app/server generate

            - name: Type Check Project
              run: yarn workspaces foreach -p run typecheck

    e2e-testing:
        name: E2E Testing
        runs-on: ubuntu-latest
        environment: development
        timeout-minutes: 60

        steps:
            - name: Setup
              uses: actions/checkout@v2

            - uses: actions/setup-node@v2
              with:
                  node-version: '16'

            - name: Start Redis
              uses: supercharge/redis-github-action@1.4.0
              with:
                  redis-version: 6

            - name: Yarn Install
              run: yarn install

            - name: Prisma Generate
              run: yarn workspace @app/server generate

            - name: Install Playwright
              run: yarn workspace @app/e2e run playwright install --with-deps

            # Adding extra browser for testing on edge since it is not included by default
            - name: Install Playwright Microsoft Edge
              run: yarn workspace @app/e2e run playwright install msedge

            - name: Run Playwright tests
              run: yarn workspace @app/e2e run test:ci

            - uses: actions/upload-artifact@v2
              if: always()
              with:
                  name: allure-report
                  path: app/e2e/allure-report/
                  retention-days: 30

    server-testing:
        name: Server Unit+Integration Testing
        runs-on: ubuntu-latest
        environment: development
        timeout-minutes: 60

        steps:
            - name: Setup
              uses: actions/checkout@v2

            - uses: actions/setup-node@v2
              with:
                  node-version: '16'
                  
            - name: Start Redis
              uses: supercharge/redis-github-action@1.4.0
              with:
                  redis-version: 6

            - name: Yarn Install
              run: yarn install

            - name: Prisma Generate
              run: yarn workspace @app/server generate

            - name: Run tests
              run: yarn workspace @app/server run test:ci

    build-client:
        name: Build Client
        runs-on: ubuntu-latest
        environment: development
        needs: [linting, e2e-testing, typechecking]

        steps:
            - name: Checkout
              uses: actions/checkout@v2

            - uses: dorny/paths-filter@v2
              id: changes
              with:
                  filters: |
                      client:
                        - 'app/client/**'
            # Build the Client
            - name: Build Client
              run: |-
                  docker build \
                    -f ./docker/Dockerfile.client \
                    --build-arg GITHUB_SHA="$GITHUB_SHA" \
                    --build-arg GITHUB_REF="$GITHUB_REF" \
                    --build-arg GRAPHQL_URL="$GRAPHQL_URL" \
                    --build-arg DEPLOYMENT_ENV="development" \
                    --build-arg GOOGLE_ANALYTICS_ID="$GOOGLE_ANALYTICS_ID" \
                    .
    build-server:
        name: Build Server
        runs-on: ubuntu-latest
        environment: development
        needs: [linting, e2e-testing, server-testing, typechecking]

        steps:
            - name: Checkout
              uses: actions/checkout@v2

            - uses: dorny/paths-filter@v2
              id: changes
              with:
                  filters: |
                      server:
                        - 'app/server/**'
            # Build the Server
            - name: Build Server
              run: |-
                  docker build \
                    -f ./docker/Dockerfile.server \
                    --build-arg GITHUB_SHA="$GITHUB_SHA" \
                    --build-arg GITHUB_REF="$GITHUB_REF" \
                    .
